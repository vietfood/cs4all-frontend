---
import { createSupabase } from '@/lib/supabase'
import { Button } from '@/components/ui/button'
import AvatarComponent from '@/components/ui/avatar'
import LoginDialog from '@/components/ui/login-dialog'

const supabase = createSupabase(Astro.cookies, Astro.request)
const { data: { user } } = await supabase.auth.getUser()

let isAdmin = false;
if (user) {
  const { data: profile } = await supabase
    .from('profiles')
    .select('is_admin')
    .eq('id', user.id)
    .maybeSingle()
  
  if (profile?.is_admin) {
    isAdmin = true;
  }
}
---

{
  user ? (
    <div class="flex items-center gap-1 sm:gap-2">
      {isAdmin && (
        <a href="/admin/review">
          <Button variant="ghost" className="text-sm px-2 h-9">Admin</Button>
        </a>
      )}
      <a href="/profile">
        <Button variant="ghost" className="text-sm px-2 gap-2 h-9">
          <AvatarComponent
            client:load
            src={user.user_metadata?.avatar_url}
            alt={user.user_metadata?.display_name || user.email || 'User'}
            fallback={user.email?.[0]?.toUpperCase() || 'U'}
            className="size-6 rounded-full"
          />
        </Button>
      </a>
      <form action="/api/auth/signout" method="post" class="inline-flex">
        <Button variant="ghost" type="submit" className="text-sm px-2 h-9">
          Logout
        </Button>
      </form>
    </div>
  ) : (
    <LoginDialog client:load />
  )
}
